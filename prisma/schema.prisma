
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String     @id
  email         String     @unique
  name          String?
  role          UserRole   @default(user)
  status        UserStatus @default(ACTIVE)
  emailVerified Boolean    @default(false)
  image         String?
  phone         String?
  lastLoginAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @default(now()) @updatedAt

  // Onboarding fields
  onboardingCompleted Boolean @default(false)
  onboardingData      Json?

  // Admin plugin fields
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?

  // Relations
  sessions      Session[]
  accounts      Account[]
  workspaces    WorkspaceMember[]
  invitationsSent WorkspaceInvitation[]

  // Default workspace
  defaultWorkspaceId String?
  defaultWorkspace   Workspace? @relation("UserDefaultWorkspace", fields: [defaultWorkspaceId], references: [id], onDelete: SetNull)

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Active workspace context
  activeWorkspaceId String?
  activeWorkspace   Workspace? @relation(fields: [activeWorkspaceId], references: [id], onDelete: SetNull)

  // Admin plugin field for impersonation
  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// Workspace model for multi-tenancy
model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     WorkspaceMember[]
  invitations WorkspaceInvitation[]
  sessions    Session[]
  defaultForUsers User[] @relation("UserDefaultWorkspace")

  // Billing
  polarCustomerId  String?
  stripeCustomerId String?
  subscriptionId   String?
  subscriptionStatus String? // active, past_due, canceled, etc.

  // Polar OAuth Integration
  polarIntegration PolarIntegration?

  @@map("workspace")
}

// Polar OAuth Integration - stores tokens and provisioning state per workspace
model PolarIntegration {
  id          String   @id @default(cuid())
  workspaceId String   @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // OAuth tokens (encrypted at rest)
  accessToken      String
  refreshToken     String?
  tokenExpiresAt   DateTime?

  // Polar organization info
  polarOrgId       String
  polarOrgSlug     String?
  polarOrgName     String?

  // Provisioning state
  provisionedAt    DateTime?
  webhookEndpointId String?
  webhookSecret    String?   // Encrypted

  // Environment: sandbox or production
  environment      String    @default("sandbox")

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Product mappings
  productMappings  PolarProductMapping[]

  @@map("polar_integration")
}

// Maps local plan IDs to Polar product IDs
model PolarProductMapping {
  id             String           @id @default(cuid())
  integrationId  String
  integration    PolarIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  planId         String   // Local plan ID from config/plans.ts (e.g., "pro-monthly")
  polarProductId String   // Polar's UUID

  createdAt      DateTime @default(now())

  @@unique([integrationId, planId])
  @@map("polar_product_mapping")
}

// Junction table for user-workspace relationship
model WorkspaceMember {
  id          String   @id @default(cuid())
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())

  // Relations
  userId      String
  workspaceId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_member")
}

// Workspace invitation model
model WorkspaceInvitation {
  id          String   @id @default(cuid())
  email       String
  role        Role     @default(MEMBER)
  token       String   @unique @default(cuid())
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())

  // Relations
  workspaceId String
  invitedById String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation(fields: [invitedById], references: [id])

  @@index([email])
  @@index([workspaceId])
  @@map("workspace_invitation")
}

// Role enum for workspace members
enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// User role enum for application-wide permissions
enum UserRole {
  user
  admin
}

// User account status enum
enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}
